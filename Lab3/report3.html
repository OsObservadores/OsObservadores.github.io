<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<h1 id="relat-rio-laborat-rio-1">Relatório Laboratório 3 - Câmeras Estéreo</h1>
<p>Jorge Luiz Pinto Junior  - RA: 11058715 - CEO</p>
<p>Marcos Baldrigue Andrade - RA: 11201921777 - CFO - Financeiro</p>
<p>Guilherme Eduardo Pereira - RA: 11201720498 - CPO - Desenvolvimento</p>
<p>Data de realização do experimento: 02/07/2025</p>
<p>Data de publicação do relatório: 21/07/2025</p>
<h2 id="introdu-o">Introdução</h2>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
O presente relatório tem como objetivo apresentar o estudo e a aplicação prática de conceitos fundamentais relacionados à visão computacional. Inicialmente, compreende-se os princípios teóricos de Estereoscopia e Geometria Epipolar, que fornecem a base para a análise de imagens captadas por sistemas de câmeras estéreo. Em seguida, realiza-se um experimento de imagem tridimensional (3D) por meio da calibração de câmeras estéreo, a fim de validar os conceitos abordados e observar, de forma prática, a reconstrução de cenas em três dimensões. Por fim, elabora-se este relatório em equipe, integrando os resultados obtidos, a análise dos procedimentos adotados e a reflexão sobre o aprendizado adquirido ao longo do desenvolvimento do trabalho.
</p> 

<h2 id="procedimentos-experimentais">Procedimentos Experimentais</h2>

<h3 id="-parte-1">PARTE 1 - Estudo da teoria.</h3>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
Foram apresentados os seguintes links com o conteúdo a ser estudado para execução do experimento: <strong>Link 1:</strong> <a href="https://learnopencv.com/introduction-to-epipolar-geometry-and-stereo-vision/" target="_blank">
    Introduction to Epipolar Geometry and Stereo Vision
  </a>
 e <strong>Link 2:</strong> <a href="https://learnopencv.com/making-a-low-cost-stereo-camera-using-opencv/" target="_blank">
        Making a Low-Cost Stereo Camera Using OpenCV
  </a>.
  </p> 

<h3 id="-parte-2">PARTE 2 - Construção de uma câmera estereoscópica simples.</h3>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
Foram fornecidas duas câmeras identicas no laboratório. As duas câmeras foram fixadas em uma prancheta, lado a lado, de tal forma que o centro das lentes do óculos 3D vermelho-ciano coincidiam com o centro da lente de cada câmera.
</p>

<h3 id="-parte-3">PARTE 3 - Calibração de uma câmera estereoscópica e geração de imagem 3D.</h3>

<h3 id="-a-leitura-de-imagem-em-arquivo">(A) Obtenção dos códigos do exemplo da câmera estéreo com OpenCV.</h3>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
Os códigos utilizados para o experimento foram retirados do seguinte repositório: <strong>Link:</strong><a href="https://github.com/spmallick/learnopencv/tree/master/stereo-camera" target="_blank">
    Stereo-camera.
  </a>
</p> 


<h3 id="-b-leitura-de-v-deo-em-arquivo">(B) Exemplo com imagens fornecidas.</h3>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
  Para realização desta etapa, foram fornecidas imagens tiradas de uma câmera estereoscópica (junção de duas câmeras iguais) desconhecida. As imagens para cada câmera foram geradas ao mesmo tempo. E através destas, foram calibradas as duas câmeras (lado direito e lado esquerdo). A seguir são apresentadas as imagens fornecidas, onde a imagem a esquerda provém da primeira câmera e a imagem a direita da segunda câmera.
</p>

<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img1.png" alt="letf01" width="400" height="200">
  <img src="/Lab3/data/stereoR/img1.png" alt="right01" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img2.png" alt="letf02" width="400" height="200">
  <img src="/Lab3/data/stereoR/img2.png" alt="right02" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img3.png" alt="letf03" width="400" height="200">
  <img src="/Lab3/data/stereoR/img3.png" alt="right03" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img4.png" alt="letf04" width="400" height="200">
  <img src="/Lab3/data/stereoR/img4.png" alt="right04" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img5.png" alt="left05" width="400" height="200">
  <img src="/Lab3/data/stereoR/img5.png" alt="right05" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img6.png" alt="left06" width="400" height="200">
  <img src="/Lab3/data/stereoR/img6.png" alt="right06" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img7.png" alt="letf07" width="400" height="200">
  <img src="/Lab3/data/stereoR/img7.png" alt="right07" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img8.png" alt="left08" width="400" height="200">
  <img src="/Lab3/data/stereoR/img8.png" alt="right08" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img9.png" alt="letf09" width="400" height="200">
  <img src="/Lab3/data/stereoR/img9.png" alt="right09" width="400" height="200">
</div>

<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img10.png" alt="letf10" width="400" height="200">
  <img src="/Lab3/data/stereoR/img10.png" alt="right10" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img11.png" alt="letf11" width="400" height="200">
  <img src="/Lab3/data/stereoR/img11.png" alt="right11" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img12.png" alt="letf12" width="400" height="200">
  <img src="/Lab3/data/stereoR/img12.png" alt="right12" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img13.png" alt="letf13" width="400" height="200">
  <img src="/Lab3/data/stereoR/img13.png" alt="right13" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img14.png" alt="letf14" width="400" height="200">
  <img src="/Lab3/data/stereoR/img14.png" alt="right14" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img15.png" alt="left15" width="400" height="200">
  <img src="/Lab3/data/stereoR/img15.png" alt="right15" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img16.png" alt="left16" width="400" height="200">
  <img src="/Lab3/data/stereoR/img16.png" alt="right16" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img17.png" alt="letf17" width="400" height="200">
  <img src="/Lab3/data/stereoR/img17.png" alt="right17" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img18.png" alt="left18" width="400" height="200">
  <img src="/Lab3/data/stereoR/img18.png" alt="right18" width="400" height="200">
</div>


<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img19.png" alt="letf19" width="400" height="200">
  <img src="/Lab3/data/stereoR/img19.png" alt="right19" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img20.png" alt="letf20" width="400" height="200">
  <img src="/Lab3/data/stereoR/img20.png" alt="right20" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img21.png" alt="letf21" width="400" height="200">
  <img src="/Lab3/data/stereoR/img21.png" alt="right21" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img22.png" alt="letf22" width="400" height="200">
  <img src="/Lab3/data/stereoR/img22.png" alt="right22" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img23.png" alt="left23" width="400" height="200">
  <img src="/Lab3/data/stereoR/img23.png" alt="right23" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img24.png" alt="left24" width="400" height="200">
  <img src="/Lab3/data/stereoR/img24.png" alt="right24" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img25.png" alt="letf25" width="400" height="200">
  <img src="/Lab3/data/stereoR/img25.png" alt="right25" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img26.png" alt="left26" width="400" height="200">
  <img src="/Lab3/data/stereoR/img26.png" alt="right26" width="400" height="200">
</div>
<div style="display: flex; justify-content: center; gap: 5px;">
  <img src="/Lab3/data/stereoL/img27.png" alt="letf27" width="400" height="200">
  <img src="/Lab3/data/stereoR/img27.png" alt="right27" width="400" height="200">
</div>
<div style="display: flex; justify-content: center">
  <figcaption>Figura 1 - Imagens fornecidas para calibração.</figcaption>
</div>
  

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
Inicialmente, realiza-se a calibração individual de cada câmera por meio do método de calibração OpenCV. Em seguida, determina-se a transformação entre as duas câmeras configuradas no sistema estéreo. Com os parâmetros obtidos, emprega-se o método <strong>stereoCalibrate</strong> para calcular as transformações necessárias à retificação estéreo. A partir disso, utiliza-se o método <strong>initUndistortRectifyMap</strong> para gerar o mapeamento que corrige distorções e prepara as imagens para retificação. Por fim, aplica-se esse mapeamento às imagens originais, obtendo-se um par estéreo retificado e livre de distorções.
</p>
<h3 id="-b-leitura-de-v-deo-em-arquivo">(1) Calibração das câmeras individuais utilizando o método de calibração OpenCV.</h3>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
  O script a seguir foi utilizado para a calibração das duas câmeras que compoe a câmera estereoscópica. Foi aberto um terminal do linux na pasta que contém as imagens fornecidas e o programa abaixo foi executado.
</p>

<pre><code class="language-python">
import numpy as np 
import cv2
from tqdm import tqdm

# Set the path to the images captured by the left and right cameras
pathL = "/home/ufabc/Documentos/cv2025/Lab3_Camera_3D/stereo-camera/data/stereoL/"
pathR = "/home/ufabc/Documentos/cv2025/Lab3_Camera_3D/stereo-camera/data/stereoR/"

print("Extracting image coordinates of respective 3D pattern ....\n")

# Termination criteria for refining the detected corners
criteria = (cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, 30, 0.001)


objp = np.zeros((8*6,3), np.float32)
objp[:,:2] = np.mgrid[0:8,0:6].T.reshape(-1,2)

img_ptsL = []
img_ptsR = []
obj_pts = []

for i in tqdm(range(1,19)):
	imgL = cv2.imread('/home/ufabc/Documentos/cv2025/Lab3_Camera_3D/stereo-camera/data/stereoL/img%d.png'%i)
	imgR = cv2.imread('/home/ufabc/Documentos/cv2025/Lab3_Camera_3D/stereo-camera/data/stereoR/img%d.png'%i)
	imgL_gray = cv2.imread('/home/ufabc/Documentos/cv2025/Lab3_Camera_3D/stereo-camera/data/stereoL/img%d.png'%i,0)
	imgR_gray = cv2.imread('/home/ufabc/Documentos/cv2025/Lab3_Camera_3D/stereo-camera/data/stereoR/img%d.png'%i,0)

	outputL = imgL.copy()
	outputR = imgR.copy()

	retR, cornersR =  cv2.findChessboardCorners(outputR,(8,6),None)
	retL, cornersL = cv2.findChessboardCorners(outputL,(8,6),None)

	if retR and retL:
		obj_pts.append(objp)
		cv2.cornerSubPix(imgR_gray,cornersR,(11,11),(-1,-1),criteria)
		cv2.cornerSubPix(imgL_gray,cornersL,(11,11),(-1,-1),criteria)
		cv2.drawChessboardCorners(outputR,(8,6),cornersR,retR)
		cv2.drawChessboardCorners(outputL,(8,6),cornersL,retL)
		cv2.imshow('cornersR',outputR)
		cv2.imshow('cornersL',outputL)
		cv2.waitKey(0)

		img_ptsL.append(cornersL)
		img_ptsR.append(cornersR)


print("Calculating left camera parameters ... ")
# Calibrating left camera
retL, mtxL, distL, rvecsL, tvecsL = cv2.calibrateCamera(obj_pts,img_ptsL,imgL_gray.shape[::-1],None,None)
hL,wL= imgL_gray.shape[:2]
new_mtxL, roiL= cv2.getOptimalNewCameraMatrix(mtxL,distL,(wL,hL),1,(wL,hL))

print("Calculating right camera parameters ... ")
# Calibrating right camera
retR, mtxR, distR, rvecsR, tvecsR = cv2.calibrateCamera(obj_pts,img_ptsR,imgR_gray.shape[::-1],None,None)
hR,wR= imgR_gray.shape[:2]
new_mtxR, roiR= cv2.getOptimalNewCameraMatrix(mtxR,distR,(wR,hR),1,(wR,hR))


print("Stereo calibration .....")
flags = 0
flags |= cv2.CALIB_FIX_INTRINSIC
# Here we fix the intrinsic camara matrixes so that only Rot, Trns, Emat and Fmat are calculated.
# Hence intrinsic parameters are the same 

criteria_stereo= (cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, 30, 0.001)


# This step is performed to transformation between the two cameras and calculate Essential and Fundamenatl matrix
retS, new_mtxL, distL, new_mtxR, distR, Rot, Trns, Emat, Fmat = cv2.stereoCalibrate(obj_pts,
                                                          img_ptsL,
                                                          img_ptsR,
                                                          new_mtxL,
                                                          distL,
                                                          new_mtxR,
                                                          distR,
                                                          imgL_gray.shape[::-1],
                                                          criteria_stereo,
                                                          flags)

# Once we know the transformation between the two cameras we can perform stereo rectification
# StereoRectify function
rectify_scale= 1 # if 0 image croped, if 1 image not croped
rect_l, rect_r, proj_mat_l, proj_mat_r, Q, roiL, roiR= cv2.stereoRectify(new_mtxL, distL, new_mtxR, distR,
                                                 imgL_gray.shape[::-1], Rot, Trns,
                                                 rectify_scale,(0,0))

# Use the rotation matrixes for stereo rectification and camera intrinsics for undistorting the image
# Compute the rectification map (mapping between the original image pixels and 
# their transformed values after applying rectification and undistortion) for left and right camera frames
Left_Stereo_Map= cv2.initUndistortRectifyMap(new_mtxL, distL, rect_l, proj_mat_l,
                                             imgL_gray.shape[::-1], cv2.CV_16SC2)
Right_Stereo_Map= cv2.initUndistortRectifyMap(new_mtxR, distR, rect_r, proj_mat_r,
                                              imgR_gray.shape[::-1], cv2.CV_16SC2)


print("Saving paraeters ......")
cv_file = cv2.FileStorage("data/params_py.xml", cv2.FILE_STORAGE_WRITE)
cv_file.write("Left_Stereo_Map_x",Left_Stereo_Map[0])
cv_file.write("Left_Stereo_Map_y",Left_Stereo_Map[1])
cv_file.write("Right_Stereo_Map_x",Right_Stereo_Map[0])
cv_file.write("Right_Stereo_Map_y",Right_Stereo_Map[1])
cv_file.release()
</code></pre>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
  O resultado da execução do script acima é mostrado na sessão <strong>"Análise dos resultados"</strong>.
</p>

<h3 id="-b-leitura-de-v-deo-em-arquivo">(2) Determinação da transformação entre as duas câmeras usadas na configuração da câmera estéreo.</h3>
<h3 id="-b-leitura-de-v-deo-em-arquivo">(3) Utilização dos parâmetros obtidos nas etapas 1 e 2 e o método stereoCalibrate para determinar as transformações aplicadas a ambas as imagens para retificação estéreo.</h3>
<h3 id="-b-leitura-de-v-deo-em-arquivo">(4) Mapeamento para encontrar o par de imagens estéreo sem distorção e retificado através do método initUndistortRectifyMap.</h3>
<h3 id="-b-leitura-de-v-deo-em-arquivo">(5) Utilização do mapeamento da etapa 4 para aplicar às imagens originais a fim de obter um par de imagens estéreo retificadas e sem distorções</h3>
 
<h3 id="-c-leitura-de-imagem-de-c-mera">(C) Execute a calibração da sua câmera estéreo (contruída com as webcams) pela captura de suas próprias imagens de calibração e imagens de teste:</h3>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
  Alterar o programa. Obter 10 a 15 imagens do padrão de calibração: python3 capture_imagens_abc.py
  Com as imagens obtidas, calibrar a câmera estéreo: python3 calibrate_abc.py
  Alterar o programa para apresentar as imagens da sua câmera estéreo ao vivo: python3 movie3d.py
</p>
<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
  Responda: liste todos os parâmetros e valores obtidos para sua câmera estéreo,
colocando-os nas formas de matrizes e vetores. Quais destes parâmetros forma
salvos no arquivo de parâmetros de calibração (xml)?
</p>


<h3 id="-d-grava-o-de-v-deo-da-c-mera">(D) Realize a gravação de um vídeo 3D com sua câmera estéreo.</h3>

<p style="text-align: justify; line-height: 1.5; text-indent: 2em;">
 Responda: a percepção individual de todos integrantes da equipe. Compare e
analise as diferenças com os resultados ao vivo e gravado.
</p>

<h2 id="analise-dos-resultados">Análise dos Resultados</h2>

<h3 id="-a-leitura-de-imagem-em-arquivo">(A) Obtenção dos códigos do exemplo da câmera estéreo com OpenCV.</h3>
<h3 id="-b-leitura-de-v-deo-em-arquivo">(B) Execute o exemplo com as imagens fornecidas.</h3>
<h3 id="-c-leitura-de-imagem-de-c-mera">(C) Execute a calibração da sua câmera estéreo (contruída com as webcams) pela captura de suas próprias imagens de calibração e imagens de teste:</h3>
<h3 id="-d-grava-o-de-v-deo-da-c-mera">(D) Realize a gravação de um vídeo 3D com sua câmera estéreo.</h3>


<h2 id="conclus-o">Conclusão</h2>

<h3>Referências</h3>
  <p>
    LEARNOPENCV. Geometry of Image Formation. Disponível em: https://learnopencv.com/geometry-of-image-formation/. Acesso em: 2 jul. 2025.
  </p>
  <p>
    LEARNOPENCV. Camera Calibration using OpenCV. Disponível em: https://learnopencv.com/camera-calibration-using-opencv/. Acesso em: 2 jul. 2025.
  </p>
  <p>
    OPENCV. Camera calibration with OpenCV. Disponível em: https://docs.opencv.org/4.x/dc/dbb/tutorial_py_calibration.html. Acesso em: 2 jul. 2025.
  </p>
</section>
  
